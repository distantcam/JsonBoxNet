name: .NET Core Build & Test

on: push

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build with dotnet
      run: dotnet build --configuration Release
      working-directory: ./src
    - name: Run unit tests
      run: dotnet test
      working-directory: ./src
    - name: Generate documentation
      run: |
        rd docs\api /s /q
        dotnet tool install --global xmldocmd
        dotnet tool install --global InheritDocTool
        InheritDoc -b src -o
        cd src/JsonBoxNet/bin/Release/net462
        xmldocmd JsonBoxNet.dll ../../../../../docs/api
        cd ../../../../../src/JsonBoxNet.Newtonsoft/bin/Release/net462
        xmldocmd JsonBoxNet.Newtonsoft.dll ../../../../../docs/api
        cd ../../../../../src/JsonBoxNet.TextJson/bin/Release/net462
        xmldocmd JsonBoxNet.TextJson.dll ../../../../../docs/api
      shell: cmd
    - name: Push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/api
        git commit -m "Doco changes" -a  || echo "nothing to commit"
        remote="https://${GITHUB_ACTOR}:${{secrets.GITHUB_TOKEN}}@github.com/${GITHUB_REPOSITORY}.git"
        branch="${GITHUB_REF:11}"
        git push "${remote}" ${branch} || echo "nothing to push"
      shell: bash